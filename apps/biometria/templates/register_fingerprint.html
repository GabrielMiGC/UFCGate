{% extends 'base.html' %}

{% block title %}Cadastro de Usuário{% endblock %}

{% block content %}
<form method="post" class="bg-white p-6 rounded-xl shadow border max-w-4xl">
    {% csrf_token %}
    <h2 class="text-2xl font-bold mb-4">Dados do Usuário</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {{ uform.as_p }}
    </div>

    <h2 class="text-2xl font-bold mt-6 mb-2">Digitais</h2>
    <p class="text-sm text-gray-500 mb-3">Capture ao menos duas digitais (ex: Indicador DIR. e Polegar DIR.). O bridge serial enviará o template; se necessário, cole o valor em template_b64.</p>
        {{ dformset.management_form }}
        <div id="finger-list" class="space-y-4">
            {% for form in dformset %}
                        <div class="p-4 border rounded finger-item">
                    <h3 class="font-semibold mb-2">Digital {{ forloop.counter }}</h3>
                            {{ form.as_p }}
                            <button type="button" class="mt-2 bg-gray-100 hover:bg-gray-200 text-gray-800 py-1 px-3 rounded fetch-capture">Pegar última captura</button>
                </div>
            {% endfor %}
        </div>
        <template id="finger-empty-template">
                <div class="p-4 border rounded finger-item">
                <h3 class="font-semibold mb-2">Digital __num__</h3>
                    {{ dformset.empty_form.as_p|safe }}
                    <button type="button" class="mt-2 bg-gray-100 hover:bg-gray-200 text-gray-800 py-1 px-3 rounded fetch-capture">Pegar última captura</button>
            </div>
        </template>

    <div class="mt-6 flex gap-3">
            <button type="button" id="add-finger" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded">Adicionar outro dedo</button>
            <button class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded">Finalizar Cadastro</button>
        <a href="{% url 'dashboard' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded">Cancelar</a>
    </div>

    {% if messages %}
        <div class="mt-6">
            {% for message in messages %}
                <div class="p-3 rounded border {% if message.tags == 'success' %}bg-green-50 border-green-200 text-green-800{% elif message.tags == 'error' %}bg-red-50 border-red-200 text-red-800{% else %}bg-gray-50 border-gray-200 text-gray-700{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}
</form>
<script>
        (function() {
        const addBtn = document.getElementById('add-finger');
        const list = document.getElementById('finger-list');
        const mgmtTotal = document.getElementById('id_d-TOTAL_FORMS');
        const tmpl = document.getElementById('finger-empty-template').innerHTML;

        function htmlToElement(html) {
            const t = document.createElement('template');
            t.innerHTML = html.trim();
            return t.content.firstElementChild;
        }

            addBtn?.addEventListener('click', () => {
            const index = parseInt(mgmtTotal.value, 10);
            let html = tmpl
                .replaceAll('__prefix__', String(index))
                .replaceAll('__num__', String(index + 1));
            const node = htmlToElement(html);
            list.appendChild(node);
            mgmtTotal.value = String(index + 1);
        });

            async function fetchLatest() {
                try {
                    const res = await fetch('/api/capture/latest/');
                    const data = await res.json();
                    return data?.template_b64 || '';
                } catch (e) { return ''; }
            }

            async function handleFetchClick(btn) {
                const wrapper = btn.closest('.finger-item');
                if (!wrapper) return;
                // find the textarea inside this block
                const ta = wrapper.querySelector('textarea');
                if (!ta) return;
                const b64 = await fetchLatest();
                if (b64) {
                    ta.value = b64;
                } else {
                    alert('Nenhuma captura recente encontrada.');
                }
            }

            document.addEventListener('click', (e) => {
                if (e.target && e.target.classList.contains('fetch-capture')) {
                    e.preventDefault();
                    handleFetchClick(e.target);
                }
            });
    })();
    </script>
{% endblock %}
